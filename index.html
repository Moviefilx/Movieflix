<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MovieFlix - Aapki Apni Movie Website</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* All CSS is same as before */
        body { font-family: 'Inter', sans-serif; background-color: #111827; } .hidden { display: none; } ::-webkit-scrollbar { width: 8px; height: 8px; } ::-webkit-scrollbar-track { background: #1f2937; } ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; } ::-webkit-scrollbar-thumb:hover { background: #6b7280; } .modal, #video-quality-menu { transition: opacity 0.3s ease; } .quality-option.active { background-color: #dc2626; font-weight: bold; } .video-container { position: relative; } .custom-controls { position: absolute; bottom: 0; left: 0; right: 0; background: linear-gradient(to top, rgba(0,0,0,0.7), transparent); opacity: 0; transition: opacity 0.3s ease; z-index: 21; } .video-container:hover .custom-controls, .video-container.paused .custom-controls { opacity: 1; } #seek-bar { -webkit-appearance: none; width: 100%; height: 5px; background: rgba(255, 255, 255, 0.3); border-radius: 5px; cursor: pointer; outline: none; transition: height 0.2s ease; } #seek-bar:hover { height: 8px; } #seek-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 16px; height: 16px; background: #dc2626; border-radius: 50%; cursor: pointer; } #volume-bar { -webkit-appearance: none; width: 80px; height: 5px; background: rgba(255, 255, 255, 0.3); border-radius: 5px; cursor: pointer; } #volume-bar::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: #fff; border-radius: 50%; } .sub-nav-links::-webkit-scrollbar { height: 4px; } .sub-nav-links::-webkit-scrollbar-thumb { background: #6b7280; } .nav-category.active { color: #ffffff; background-color: rgba(220, 38, 38, 0.5); }
    </style>
</head>
<body class="text-white">

    <!-- HTML Structure is same as before -->
    <header class="bg-gray-900/80 backdrop-blur-sm sticky top-0 z-40 shadow-lg"><nav class="container mx-auto px-6 py-4 flex justify-between items-center"><div class="text-2xl font-bold text-red-600 tracking-wider cursor-pointer" id="main-logo"><i class="fas fa-film mr-2"></i>MovieFlix</div><div><button id="admin-login-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"><i class="fas fa-user-shield mr-2"></i>Admin Login</button><button id="home-btn" class="hidden bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"><i class="fas fa-home mr-2"></i>Home</button></div></nav></header>
    <main class="container mx-auto px-6 py-8">
        <div id="user-view">
            <div id="sub-nav" class="bg-gray-800/50 backdrop-blur-sm rounded-lg p-2 mb-8"><div class="flex justify-between items-center"><div class="sub-nav-links flex items-center overflow-x-auto space-x-2 md:space-x-4"><a href="#" class="nav-category text-sm md:text-base font-semibold text-gray-300 hover:text-white px-3 py-2 rounded-md transition-colors whitespace-nowrap" data-category="All">All Movies</a><a href="#" class="nav-category text-sm md:text-base font-semibold text-gray-300 hover:text-white px-3 py-2 rounded-md transition-colors whitespace-nowrap" data-category="BollyWood">BollyWood</a><a href="#" class="nav-category text-sm md:text-base font-semibold text-gray-300 hover:text-white px-3 py-2 rounded-md transition-colors whitespace-nowrap" data-category="HollyWood">HollyWood</a><a href="#" class="nav-category text-sm md:text-base font-semibold text-gray-300 hover:text-white px-3 py-2 rounded-md transition-colors whitespace-nowrap" data-category="Hindi Dubbed">Hindi Dubbed</a><a href="#" class="nav-category text-sm md:text-base font-semibold text-gray-300 hover:text-white px-3 py-2 rounded-md transition-colors whitespace-nowrap" data-category="South Hindi">South Hindi</a><a href="#" class="nav-category text-sm md:text-base font-semibold text-gray-300 hover:text-white px-3 py-2 rounded-md transition-colors whitespace-nowrap" data-category="Web Series">Web Series</a><a href="#" class="nav-category text-sm md:text-base font-semibold text-gray-300 hover:text-white px-3 py-2 rounded-md transition-colors whitespace-nowrap" data-category="18+">18+</a></div><div class="pl-4 flex items-center gap-2"><input type="text" id="search-input" placeholder="Search movies..." class="hidden w-40 md:w-64 bg-gray-700 border border-gray-600 rounded-lg p-2 text-sm focus:ring-red-500 focus:border-red-500 transition-all duration-300"><button id="search-btn" class="text-xl text-gray-300 hover:text-white"><i class="fas fa-search"></i></button></div></div></div>
            
            <!-- Error Message View -->
            <div id="server-error-view" class="hidden text-center bg-red-900/50 border border-red-700 p-8 rounded-lg">
                <h2 class="text-2xl font-bold text-red-400 mb-4"><i class="fas fa-server mr-2"></i> Server Connection Error</h2>
                <div id="server-error-message" class="text-gray-300"></div>
            </div>
            
            <h1 id="page-title" class="text-3xl font-bold mb-8 border-l-4 border-red-600 pl-4">Latest Movies</h1>
            <div id="movie-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-8"></div>
        </div>
        <div id="video-player-view" class="hidden"><button id="back-to-home-btn" class="mb-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"><i class="fas fa-arrow-left mr-2"></i>Back to List</button><div id="video-container" class="video-container bg-black rounded-lg overflow-hidden shadow-2xl aspect-video"><video id="video-player" class="w-full h-full"></video><div class="custom-controls p-4 space-y-2"><input type="range" id="seek-bar" value="0" step="1"><div class="flex justify-between items-center"><div class="flex items-center gap-4"><button id="play-pause-btn" class="text-2xl"><i class="fas fa-play"></i></button><div class="flex items-center gap-2"><button id="volume-btn" class="text-xl"><i class="fas fa-volume-up"></i></button><input type="range" id="volume-bar" min="0" max="1" step="0.1" value="1"></div><div class="text-sm"><span id="current-time">00:00</span> / <span id="total-duration">00:00</span></div></div><div class="flex items-center gap-4"><div class="relative"><button id="settings-btn" class="text-xl"><i class="fas fa-cog"></i></button><div id="video-quality-menu" class="hidden absolute bottom-full right-0 mb-2 bg-gray-900/80 backdrop-blur-sm rounded-lg py-2 w-32 shadow-lg"></div></div><button id="pip-btn" class="text-xl"><i class="fas fa-compress-alt"></i></button><button id="fullscreen-btn" class="text-xl"><i class="fas fa-expand"></i></button></div></div></div></div><div class="mt-4 bg-gray-800 p-6 rounded-lg"><h2 id="video-title" class="text-3xl font-bold"></h2><p id="video-desc" class="text-gray-400 mt-2"></p></div></div>
        <div id="admin-login-view" class="hidden max-w-md mx-auto bg-gray-800 p-8 rounded-2xl shadow-2xl mt-16"><h2 class="text-2xl font-bold mb-6 text-center">Admin Panel Login</h2><form id="login-form"><div class="mb-4"><label for="password" class="block mb-2 text-sm font-medium">Password</label><input type="password" id="password" name="password" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500" placeholder="••••••••" required></div><button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2.5 px-5 rounded-lg transition duration-300">Login</button><p id="login-error" class="text-red-500 text-sm mt-4 text-center hidden">Galat password!</p></form></div>
        <div id="admin-panel-view" class="hidden"><div class="flex justify-between items-center mb-8"><h1 class="text-3xl font-bold border-l-4 border-red-600 pl-4">Admin Panel</h1><button id="logout-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300"><i class="fas fa-sign-out-alt mr-2"></i>Logout</button></div><div class="bg-gray-800 p-8 rounded-2xl shadow-2xl max-w-2xl mx-auto"><h2 class="text-2xl font-bold mb-6" id="form-title">Nayi Movie Upload Karein</h2><form id="upload-form"><input type="hidden" id="movie-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="mb-4"><label for="movie-title" class="block mb-2 text-sm font-medium">Movie Title</label><input type="text" id="movie-title" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500" placeholder="Jaise: '3 Idiots'" required></div><div class="mb-4"><label for="movie-category" class="block mb-2 text-sm font-medium">Category</label><select id="movie-category" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500" required><option value="BollyWood">BollyWood</option><option value="HollyWood">HollyWood</option><option value="Hindi Dubbed">Hindi Dubbed</option><option value="South Hindi">South Hindi</option><option value="Web Series">Web Series</option><option value="18+">18+</option></select></div></div><div class="mb-4"><label for="movie-desc" class="block mb-2 text-sm font-medium">Description</label><textarea id="movie-desc" rows="4" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500" placeholder="Movie ke baare mein likhein..." required></textarea></div><div class="mb-6"><label for="movie-poster" class="block mb-2 text-sm font-medium">Poster Image URL</label><input type="url" id="movie-poster" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 focus:ring-red-500 focus:border-red-500" placeholder="https://image.url/poster.jpg" required></div><div class="mb-6 space-y-4"><h3 class="text-lg font-semibold">Video Files & Download Links</h3><div id="file-inputs-container"></div><div id="current-files-list" class="hidden text-xs text-yellow-400 mt-2 space-y-1"></div></div><div class="flex gap-4"><button type="submit" id="upload-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300 text-lg"><i class="fas fa-upload mr-2"></i>Upload Movie</button><button type="button" id="cancel-edit-btn" class="hidden w-1/3 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-5 rounded-lg transition duration-300 text-lg">Cancel</button></div></form></div><div class="mt-12"><div class="flex justify-between items-center mb-6"><h2 class="text-2xl font-bold border-l-4 border-red-600 pl-4">Manage Movies</h2><button id="clear-all-data-btn" class="bg-red-800 hover:bg-red-900 text-white font-bold py-2 px-4 rounded-lg transition duration-300 text-sm"><i class="fas fa-exclamation-triangle mr-2"></i>Clear All Data</button></div><div id="admin-movie-list" class="space-y-4"></div></div></div>
    </main>
    <div id="confirm-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"><div class="bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-sm transform transition-all scale-95 opacity-0" id="confirm-modal-content"><p id="confirm-modal-text" class="text-lg mb-6 text-center">Kya aap sure hain?</p><div class="flex justify-center gap-4"><button id="confirm-cancel-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg">Cancel</button><button id="confirm-ok-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">Haan, Delete Karein</button></div></div></div>
    
    <!-- Download Modal -->
    <div id="download-modal" class="hidden modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm transform transition-all scale-95 opacity-0" id="download-modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 id="download-modal-title" class="text-xl font-bold">Download Links</h3>
                <button id="download-modal-close-btn" class="text-2xl text-gray-400 hover:text-white">&times;</button>
            </div>
            <div id="download-links-container" class="space-y-3">
                <!-- Download links will be populated here -->
            </div>
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Elements ---
            const userView = document.getElementById('user-view');
            const adminLoginView = document.getElementById('admin-login-view');
            const adminPanelView = document.getElementById('admin-panel-view');
            const videoPlayerView = document.getElementById('video-player-view');
            const movieGrid = document.getElementById('movie-grid');
            const adminMovieList = document.getElementById('admin-movie-list');
            const loginForm = document.getElementById('login-form');
            const uploadForm = document.getElementById('upload-form');
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const homeBtn = document.getElementById('home-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const backToHomeBtn = document.getElementById('back-to-home-btn');
            const mainLogo = document.getElementById('main-logo');
            const searchInput = document.getElementById('search-input');
            const pageTitle = document.getElementById('page-title');
            const clearAllDataBtn = document.getElementById('clear-all-data-btn');
            const serverErrorView = document.getElementById('server-error-view');
            const serverErrorMessage = document.getElementById('server-error-message');


            // Video Player Elements
            const videoContainer = document.getElementById('video-container');
            const videoPlayer = document.getElementById('video-player');
            const videoTitle = document.getElementById('video-title');
            const videoDesc = document.getElementById('video-desc');
            const playPauseBtn = document.getElementById('play-pause-btn');
            const seekBar = document.getElementById('seek-bar');
            const currentTimeEl = document.getElementById('current-time');
            const totalDurationEl = document.getElementById('total-duration');
            const volumeBtn = document.getElementById('volume-btn');
            const volumeBar = document.getElementById('volume-bar');
            const settingsBtn = document.getElementById('settings-btn');
            const qualityMenu = document.getElementById('video-quality-menu');
            const pipBtn = document.getElementById('pip-btn');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            
            // Modal elements
            const confirmModal = document.getElementById('confirm-modal');
            const downloadModal = document.getElementById('download-modal');
            const downloadModalContent = document.getElementById('download-modal-content');
            const downloadModalTitle = document.getElementById('download-modal-title');
            const downloadLinksContainer = document.getElementById('download-links-container');
            const downloadModalCloseBtn = document.getElementById('download-modal-close-btn');
            let confirmCallback = null;
            
            // --- App State & Constants --- //
            const ADMIN_PASSWORD = 'Rohit1510'; 
            const API_BASE_URL = 'https://movieflix-3a7p.onrender.com';
            const AVAILABLE_QUALITIES = ['1080', '720', '480', '360', '240', '144'];
            let allMoviesCache = [];
            let currentlyPlayingMovieId = null;

            // --- API Functions ---
            async function getMoviesFromServer() {
                try {
                    serverErrorView.classList.add('hidden');
                    movieGrid.classList.remove('hidden');

                    const response = await fetch(`${API_BASE_URL}/movies`);
                    if (!response.ok) {
                        const errorData = {
                            status: response.status,
                            statusText: response.statusText,
                        }
                        throw new Error(JSON.stringify(errorData));
                    }
                    allMoviesCache = await response.json();
                } catch (error) {
                    console.error('Failed to fetch movies:', error.message);
                    
                    let status = 'Unknown';
                    try {
                       const parsedError = JSON.parse(error.message);
                       status = parsedError.status;
                    } catch(e) {
                        // Could not parse, it's a generic fetch error
                    }
                    
                    const errorMessageDiv = document.getElementById('server-error-message');
                    if (status === 500) {
                        errorMessageDiv.innerHTML = `Backend server par ek 'Internal Server Error (500)' aa raha hai.<br> Iska matlab hai ki server ke code mein ya uske configuration mein koi samasya hai.<br><strong class="text-yellow-400 mt-2 block">Action:</strong> Kripya Render par jaakar apne Environment Variables (khaas kar ke FIREBASE_CREDENTIALS aur Cloudinary keys) check karein.`;
                    } else {
                        errorMessageDiv.innerHTML = `Backend server se connect nahi ho pa raha hai.<br>
                        <strong class="text-yellow-400 mt-2 block">Action:</strong> Sunishchit karein ki aapka Render server "Deployed" state mein hai aur crash nahi hua hai. URL (` + API_BASE_URL + `) bhi check karein.`;
                    }

                    serverErrorView.classList.remove('hidden');
                    movieGrid.classList.add('hidden');
                }
            }

            async function addMovieToServer(formData) {
                try {
                    const response = await fetch(`${API_BASE_URL}/movies`, {
                        method: 'POST',
                        body: formData,
                    });
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(errorText || 'Unknown server error');
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Failed to add movie:', error.message);
                    alert(`Movie upload failed: ${error.message}`);
                }
            }
            
            async function deleteMovieFromServer(movieId) {
                try {
                    const response = await fetch(`${API_BASE_URL}/movies/${movieId}`, {
                        method: 'DELETE',
                    });
                    if (!response.ok) throw new Error('Failed to delete movie');
                    return true;
                } catch (error) {
                    console.error('Failed to delete movie:', error);
                    return false;
                }
            }
            
            // --- Render & UI Functions ---
            function renderMovies(filterCategory = 'All', searchTerm = '') {
                let moviesToRender = allMoviesCache;
                if (filterCategory !== 'All') moviesToRender = moviesToRender.filter(m => m.category === filterCategory);
                if (searchTerm) moviesToRender = moviesToRender.filter(m => m.title.toLowerCase().includes(searchTerm.toLowerCase()));

                pageTitle.textContent = searchTerm ? `Searching for "${searchTerm}"` : (filterCategory === 'All' ? "Latest Movies" : filterCategory);
                document.querySelectorAll('.nav-category').forEach(link => link.classList.toggle('active', link.dataset.category === filterCategory && !searchTerm));

                movieGrid.innerHTML = moviesToRender.length === 0 
                    ? `<p class="col-span-full text-center text-gray-400">Is criteria mein koi movie nahi mili.</p>`
                    : moviesToRender.map(movie => {
                        const categoryLabel = movie.category ? `<span class="absolute top-2 right-2 bg-red-600 text-white text-xs font-bold px-2 py-1 rounded-md">${movie.category}</span>` : '';
                        return `<div class="relative bg-gray-800 rounded-lg overflow-hidden shadow-lg transform hover:scale-105 transition-transform duration-300 group">
                            ${categoryLabel}
                            <img src="${movie.posterUrl}" alt="${movie.title}" class="w-full h-96 object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x600/1f2937/ffffff?text=Image+Nahi+Mili';">
                            <div class="p-4 flex flex-col flex-grow">
                                <h3 class="font-bold text-lg mb-2 truncate group-hover:text-red-500 transition-colors">${movie.title}</h3>
                                <p class="text-gray-400 text-sm h-16 overflow-hidden flex-grow">${movie.description}</p>
                                <div class="flex gap-2 mt-4">
                                    <button class="watch-now-btn w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300" data-id="${movie.id}">
                                        <i class="fas fa-play mr-2"></i>Watch
                                    </button>
                                    <button class="download-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300" data-id="${movie.id}">
                                        <i class="fas fa-download mr-2"></i>Download
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
            }
            
            function renderAdminMovieList() {
                adminMovieList.innerHTML = allMoviesCache.length === 0
                    ? `<p class="bg-gray-800 p-4 rounded-lg text-center text-gray-400">Abhi koi movie manage karne ke liye nahi hai.</p>`
                    : allMoviesCache.map(movie => `<div class="bg-gray-900/50 p-4 rounded-lg flex items-center justify-between hover:bg-gray-700/50 transition-colors duration-300"><div class="flex items-center gap-4 flex-1 min-w-0"><img src="${movie.posterUrl}" class="w-16 h-24 object-cover rounded-md flex-shrink-0"><div class="min-w-0"><h4 class="font-bold text-lg truncate">${movie.title}</h4><p class="text-sm text-gray-400 truncate">Category: ${movie.category || 'N/A'}</p></div></div><div class="flex gap-3 flex-shrink-0"><button class="edit-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg transition" data-id="${movie.id}"><i class="fas fa-edit"></i></button><button class="delete-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition" data-id="${movie.id}"><i class="fas fa-trash"></i></button></div></div>`).join('');
                addAdminButtonListeners();
            }

            function addAdminButtonListeners() {
                document.querySelectorAll('.delete-btn').forEach(button => button.addEventListener('click', (e) => deleteMovie(e.currentTarget.dataset.id)));
                document.querySelectorAll('.edit-btn').forEach(button => button.addEventListener('click', (e) => editMovie(e.currentTarget.dataset.id)));
            }
            
            async function deleteMovie(id) {
                 showConfirmDialog('Kya aap sach mein is movie ko delete karna chahte hain?', async () => {
                    const success = await deleteMovieFromServer(id);
                    if (success) {
                        await getMoviesFromServer();
                        renderMovies();
                        renderAdminMovieList();
                        alert('Movie safaltapoorvak delete ho gayi!');
                    }
                });
            }

            function editMovie(id) {
                const movieToEdit = allMoviesCache.find(movie => movie.id == id);
                if (movieToEdit) {
                    const form = document.getElementById('upload-form');
                    form.querySelector('#movie-id').value = movieToEdit.id;
                    form.querySelector('#movie-title').value = movieToEdit.title;
                    form.querySelector('#movie-desc').value = movieToEdit.description;
                    form.querySelector('#movie-poster').value = movieToEdit.posterUrl;
                    form.querySelector('#movie-category').value = movieToEdit.category;
                    document.getElementById('form-title').textContent = 'Movie Edit Karein';
                    document.getElementById('upload-btn').innerHTML = `<i class="fas fa-save mr-2"></i>Update Movie`;
                    document.getElementById('cancel-edit-btn').classList.remove('hidden');
                    
                    document.querySelectorAll('.movie-link-input').forEach(input => {
                        const quality = input.dataset.quality;
                        if(movieToEdit.downloadLinks && movieToEdit.downloadLinks[quality]){
                            input.value = movieToEdit.downloadLinks[quality];
                        }
                    });

                    uploadForm.scrollIntoView({ behavior: 'smooth' });
                }
            }

            function playMovie(id) {
                const movieToPlay = allMoviesCache.find(movie => movie.id == id);
                if (movieToPlay && movieToPlay.videoSources) {
                    currentlyPlayingMovieId = id;
                    showView('player');
                    videoTitle.textContent = movieToPlay.title;
                    videoDesc.textContent = movieToPlay.description;
                    const qualities = Object.keys(movieToPlay.videoSources);
                    if (qualities.length > 0) {
                        const bestQuality = qualities.sort((a,b) => parseInt(b) - parseInt(a))[0];
                        setVideoSource(bestQuality);
                        populateQualityMenu(qualities, bestQuality);
                    } else {
                         videoPlayer.src = ''; 
                         qualityMenu.innerHTML = '';
                         alert("Is movie ke liye koi video source available nahi hai.");
                    }
                } else {
                    alert("Video sources nahi mile.");
                }
            }

            function openDownloadModal(id) {
                const movieToDownload = allMoviesCache.find(movie => movie.id == id);
                if (movieToDownload && movieToDownload.downloadLinks) {
                    downloadModalTitle.textContent = `Download: ${movieToDownload.title}`;
                    downloadLinksContainer.innerHTML = '';
                    
                    const qualities = Object.keys(movieToDownload.downloadLinks).sort((a,b) => b - a);

                    if (qualities.length === 0) {
                         downloadLinksContainer.innerHTML = '<p class="text-gray-400">Is movie ke liye download links available nahi hain.</p>';
                    } else {
                        qualities.forEach(q => {
                            const url = movieToDownload.downloadLinks[q];
                            if(url) {
                                const link = document.createElement('a');
                                link.href = url;
                                link.target = "_blank"; // Open in new tab
                                link.className = 'block w-full text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300';
                                link.innerHTML = `<i class="fas fa-download mr-2"></i>Download ${q}p`;
                                downloadLinksContainer.appendChild(link);
                            }
                        });
                    }

                    downloadModal.classList.remove('hidden');
                    setTimeout(() => downloadModalContent.classList.remove('scale-95', 'opacity-0'), 10);
                } else {
                    alert("Is movie ke liye download links available nahi hain.");
                }
            }

            function closeDownloadModal() {
                downloadModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => downloadModal.classList.add('hidden'), 300);
            }
            
            function setVideoSource(quality) {
                const movie = allMoviesCache.find(m => m.id === currentlyPlayingMovieId);
                const sourceUrl = movie?.videoSources?.[quality]?.url;
                if (sourceUrl) {
                    const currentTime = videoPlayer.currentTime;
                    const isPaused = videoPlayer.paused;
                    videoPlayer.src = sourceUrl;
                    videoPlayer.addEventListener('loadedmetadata', () => {
                         videoPlayer.currentTime = currentTime;
                         if (!isPaused) videoPlayer.play();
                    }, { once: true });
                    document.querySelectorAll('.quality-option').forEach(btn => btn.classList.toggle('active', btn.dataset.quality === quality));
                }
            }
            
            function populateQualityMenu(qualities, activeQuality) {
                qualityMenu.innerHTML = '<h4 class="text-xs text-gray-400 px-3 pb-1 border-b border-gray-700">Quality</h4>';
                qualities.sort((a,b) => parseInt(b) - parseInt(a)).forEach(q => {
                    qualityMenu.innerHTML += `<button class="quality-option w-full text-left px-3 py-1 text-sm hover:bg-red-600 ${q === activeQuality ? 'active' : ''}" data-quality="${q}">${q}</button>`;
                });
            }
            
            function generateFileInputs() {
                const container = document.getElementById('file-inputs-container');
                container.innerHTML = '';
                AVAILABLE_QUALITIES.forEach(q => {
                    const inputDiv = document.createElement('div');
                    inputDiv.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 items-center';
                    inputDiv.innerHTML = `
                        <div>
                            <label for="movie-file-${q}" class="block mb-1 text-sm font-medium text-gray-400">${q}p File (for Streaming)</label>
                            <input type="file" id="movie-file-${q}" data-quality="${q}" accept="video/*" class="movie-file-input w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-600 file:text-white hover:file:bg-gray-500">
                        </div>
                         <div>
                            <label for="movie-link-${q}" class="block mb-1 text-sm font-medium text-gray-400">${q}p Download Link</label>
                            <input type="url" id="movie-link-${q}" data-quality="${q}" placeholder="https://example.com/download.mp4" class="movie-link-input w-full bg-gray-700 border border-gray-600 rounded-lg p-2.5 text-sm">
                        </div>
                    `;
                    container.appendChild(inputDiv);
                });
            }

            function showView(viewName) {
                [userView, adminLoginView, adminPanelView, videoPlayerView, serverErrorView].forEach(v => v.classList.add('hidden'));
                const views = { user: userView, login: adminLoginView, admin: adminPanelView, player: videoPlayerView };
                views[viewName].classList.remove('hidden');
                adminLoginBtn.classList.toggle('hidden', viewName !== 'user');
                homeBtn.classList.toggle('hidden', viewName === 'user');
                if(viewName === 'admin') renderAdminMovieList();
            }

            function showConfirmDialog(message, callback) {
                document.getElementById('confirm-modal-text').textContent = message;
                confirmCallback = callback;
                confirmModal.classList.remove('hidden');
                setTimeout(() => document.getElementById('confirm-modal-content').classList.remove('scale-95', 'opacity-0'), 10);
            }
            function hideConfirmDialog() {
                const content = document.getElementById('confirm-modal-content');
                content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => confirmModal.classList.add('hidden'), 300);
            }
             function resetFiltersAndSearch() {
                searchInput.value = '';
                searchInput.classList.add('hidden');
                renderMovies('All');
            }
            
            // --- Event Listeners ---
            adminLoginBtn.addEventListener('click', () => showView('login'));
            homeBtn.addEventListener('click', () => { showView('user'); resetFiltersAndSearch(); });
            logoutBtn.addEventListener('click', () => { showView('user'); resetFiltersAndSearch(); alert('Aap successfully logout ho gaye hain.'); });
            backToHomeBtn.addEventListener('click', () => { videoPlayer.pause(); videoPlayer.src = ''; showView('user'); resetFiltersAndSearch(); });
            mainLogo.addEventListener('click', () => { showView('user'); resetFiltersAndSearch(); });
            movieGrid.addEventListener('click', (e) => { 
                const watchBtn = e.target.closest('.watch-now-btn');
                const downloadBtn = e.target.closest('.download-btn');
                if (watchBtn) playMovie(watchBtn.dataset.id); 
                if (downloadBtn) openDownloadModal(downloadBtn.dataset.id);
            });
            loginForm.addEventListener('submit', (e) => { e.preventDefault(); if (document.getElementById('password').value === ADMIN_PASSWORD) { showView('admin'); renderAdminMovieList(); loginForm.reset(); } else { document.getElementById('login-error').classList.remove('hidden'); } });
            
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData();
                formData.append('title', document.getElementById('movie-title').value);
                formData.append('description', document.getElementById('movie-desc').value);
                formData.append('posterUrl', document.getElementById('movie-poster').value);
                formData.append('category', document.getElementById('movie-category').value);
                
                let fileOrLinkProvided = false;
                document.querySelectorAll('.movie-file-input').forEach(input => {
                    const quality = input.dataset.quality;
                    const linkInput = document.getElementById(`movie-link-${quality}`);
                    if (input.files[0]) {
                        fileOrLinkProvided = true;
                        formData.append(`video-${quality}`, input.files[0]);
                    }
                     if (linkInput && linkInput.value.trim()) {
                        fileOrLinkProvided = true;
                        formData.append(`downloadLink-${quality}`, linkInput.value.trim());
                    }
                });
                
                if (!fileOrLinkProvided) return alert('Kripya kam se kam ek video file ya download link provide karein.');

                const uploadBtn = document.getElementById('upload-btn');
                uploadBtn.disabled = true;
                uploadBtn.innerHTML = 'Uploading...';

                const addedMovie = await addMovieToServer(formData);
                if (addedMovie) {
                    await getMoviesFromServer();
                    renderMovies();
                    renderAdminMovieList();
                    uploadForm.reset();
                    alert('Movie safaltapoorvak upload ho gayi!');
                }
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-upload mr-2"></i>Upload Movie';
            });
            
            document.getElementById('cancel-edit-btn').addEventListener('click', () => {
                uploadForm.reset();
                document.getElementById('movie-id').value = '';
                document.getElementById('form-title').textContent = 'Nayi Movie Upload Karein';
                document.getElementById('upload-btn').innerHTML = `<i class="fas fa-upload mr-2"></i>Upload Movie`;
                document.getElementById('cancel-edit-btn').classList.add('hidden');
            });

            clearAllDataBtn.addEventListener('click', () => {
                showConfirmDialog('Kya aap sach mein saara data erase karna chahte hain? Yeh action undo nahi kiya ja sakta.', async () => {
                    const movies = allMoviesCache;
                    for(const movie of movies) {
                       await deleteMovieFromServer(movie.id);
                    }
                    await getMoviesFromServer();
                    renderMovies();
                    renderAdminMovieList();
                    alert('Saara data safaltapoorvak erase ho gaya hai.');
                });
            });

            document.getElementById('sub-nav').addEventListener('click', (e) => {
                const target = e.target.closest('.nav-category');
                if (target) {
                    e.preventDefault();
                    searchInput.value = '';
                    searchInput.classList.add('hidden');
                    renderMovies(target.dataset.category);
                }
            });
            
            document.getElementById('search-btn').addEventListener('click', () => {
                searchInput.classList.toggle('hidden');
                if(!searchInput.classList.contains('hidden')) searchInput.focus();
            });

            searchInput.addEventListener('input', () => {
                const activeCategoryLink = document.querySelector('.nav-category.active') || document.querySelector('.nav-category[data-category="All"]');
                renderMovies(activeCategoryLink.dataset.category, searchInput.value);
            });

            downloadModalCloseBtn.addEventListener('click', closeDownloadModal);
            
            // Player listeners
            const formatTime = (t) => { if(isNaN(t)) return '00:00'; const m = Math.floor(t/60), s = Math.floor(t%60); return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}` };
            videoPlayer.addEventListener('loadeddata', () => { totalDurationEl.textContent = formatTime(videoPlayer.duration); seekBar.max = videoPlayer.duration; });
            videoPlayer.addEventListener('timeupdate', () => { seekBar.value = videoPlayer.currentTime; currentTimeEl.textContent = formatTime(videoPlayer.currentTime); });
            videoPlayer.addEventListener('play', () => { playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>'; videoContainer.classList.remove('paused'); });
            videoPlayer.addEventListener('pause', () => { playPauseBtn.innerHTML = '<i class="fas fa-play"></i>'; videoContainer.classList.add('paused'); });
            const togglePlay = () => videoPlayer.paused ? videoPlayer.play() : videoPlayer.pause();
            playPauseBtn.addEventListener('click', togglePlay);
            videoPlayer.addEventListener('click', togglePlay);
            seekBar.addEventListener('input', () => videoPlayer.currentTime = seekBar.value);
            volumeBtn.addEventListener('click', () => { videoPlayer.muted = !videoPlayer.muted; volumeBtn.innerHTML = `<i class="fas ${videoPlayer.muted ? 'fa-volume-mute' : 'fa-volume-up'}"></i>`; volumeBar.value = videoPlayer.muted ? 0 : videoPlayer.volume; });
            volumeBar.addEventListener('input', (e) => { videoPlayer.volume = e.target.value; videoPlayer.muted = e.target.value == 0; volumeBtn.innerHTML = `<i class="fas ${videoPlayer.muted ? 'fa-volume-mute' : 'fa-volume-up'}"></i>`; });
            fullscreenBtn.addEventListener('click', () => { try { if (!document.fullscreenElement) videoContainer.requestFullscreen(); else document.exitFullscreen(); } catch (e) { console.warn("Fullscreen API error:", e.message); } });
            document.addEventListener('fullscreenchange', () => { fullscreenBtn.innerHTML = `<i class="fas ${document.fullscreenElement ? 'fa-compress' : 'fa-expand'}"></i>`; });
            pipBtn.addEventListener('click', () => { try { if (document.pictureInPictureElement) document.exitPictureInPicture(); else if (document.pictureInPictureEnabled) videoPlayer.requestPictureInPicture(); } catch (e) { console.warn("PiP API error:", e.message); } });
            settingsBtn.addEventListener('click', (e) => { e.stopPropagation(); qualityMenu.classList.toggle('hidden'); });
            document.addEventListener('click', () => { if (!qualityMenu.classList.contains('hidden')) qualityMenu.classList.add('hidden'); });
            qualityMenu.addEventListener('click', (e) => { if (e.target.closest('.quality-option')) setVideoSource(e.target.closest('.quality-option').dataset.quality); });
            document.getElementById('confirm-ok-btn').addEventListener('click', () => { if (confirmCallback) confirmCallback(); hideConfirmDialog(); });
            document.getElementById('confirm-cancel-btn').addEventListener('click', hideConfirmDialog);

            // --- Initial App Load ---
            async function initializeApp() {
                generateFileInputs();
                await getMoviesFromServer();
                renderMovies();
                showView('user');
            }

            initializeApp();
        });
    </script>
</body>
</html>
